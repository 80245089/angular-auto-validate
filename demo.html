<!DOCTYPE html>
<html ng-app="jcs-demo">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'/>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="http://prismjs.com/themes/prism.css" />
    <link href='http://fonts.googleapis.com/css?family=Raleway:400,200' rel='stylesheet' type='text/css'>


    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Angular-auto-validate by Jon Samwell</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Angular-auto-validate</h1>
        <h2>An automatic validation module for AngularJS which gets rid of excess html in favour of dynamic element modification to notify the user of validation errors</h2>
        <a href="https://github.com/jonsamwell/angular-auto-validate" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h3 id="getting_started">Demo.</h3>
            <div class="callout">
                <p>For the best overview of the module and module architecture see my <a href="http://www.jonsamwell.com/angular-auto-validate">original blog post here</a>.</p>
            </div>

            <div ng-controller="demoCtrl">
                <p>
                    <button type="button" class="btn btn-primary" ng-click="toggleBS3Icons();">Toggle Validation State Icons</button>
                </p>
                <form role="form">
                    <div class="form-group">
                        <label class="control-label">Name</label>
                        <input type="email"
                               class="form-control"
                               placeholder="Enter Name"
                               ng-model="user.name"
                               required="required" />
                    </div>
                    <div class="form-group">
                        <label class="control-label">Email address - <small>Element with a custom element modifier (see source code)</small></label>
                        <input type="email"
                               class="form-control"
                               placeholder="Enter email"
                               ng-model="user.email"
                               required="required"
                               element-modifier="myCustomModifierKey">
                    </div>
                    <div class="form-group">
                        <label class="control-label">Password - <small>Element with validation happening on blur rather than change</small></label>
                        <input type="password" class="form-control"
                               ng-model="user.password"
                               placeholder="Password"
                               required="required"
                               ng-minlength="6"
                               ng-model-options="{updateOn: 'blur'}">
                    </div>

                    <button type="submit" class="btn btn-default">Submit</button>
                </form>
            </div>
        </section>

        <aside id="sidebar">
            <h3>Menu</h3>
            <ul>
                <li><a href="#getting_started">Default</a></li>
                <li><a href="#your_form">Validate on Blur</a></li>
                <li><a href="#error_message_resolver">Custom Element Modifier</a></li>
            </ul>
          <a href="https://github.com/jonsamwell/angular-auto-validate/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/jonsamwell/angular-auto-validate/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/jonsamwell/angular-auto-validate"></a> is maintained by <a href="https://github.com/jonsamwell">jonsamwell</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular.min.js"></script>
    <script type="text/javascript">
    (function (angular) {
        'use strict';

        angular.module('jcs-autoValidate', []);
    }(angular));

    (function (angular) {
        'use strict';

        angular.module('jcs-autoValidate')
                .provider('validator', [

                    function () {
                        var elementStateModifiers = {};

                        /**
                         * @ngdoc function
                         * @name validator#setDefaultElementModifier
                         * @methodOf validator
                         *
                         * @description
                         * Sets the default element modifier that will be used by the validator
                         * to change an elements UI state.  Please ensure the modifier has been registered
                         * before setting it as default.
                         *
                         * Note: this can be changed by setting the
                         * element modifier attribute on the input element 'data-element-modifier="myCustomModifier"'
                         *
                         * Example:
                         * <pre>
                         *  app.config(function (validator) {
                 *    validator.setDefaultElementModifier('myCustomModifier');
                 *  });
                         * </pre>
                         *
                         * @param {string} key The key name of the modifier.
                         */
                        this.setDefaultElementModifier = function (key) {
                            if (elementStateModifiers[key] === undefined) {
                                throw new Error('Element modifier not registered: ' + key);
                            }

                            this.defaultElementModifier = key;
                        };

                        /**
                         * @ngdoc function
                         * @name validator#registerDomModifier
                         * @methodOf validator
                         *
                         * @description
                         * Registers an object that adheres to the elementModifier interface and is
                         * able to modifier an elements dom so that appears valid / invalid for a specific
                         * scenario i.e. the Twitter Bootstrap css framework, Foundation CSS framework etc.
                         *
                         * Example:
                         * <pre>
                         *  app.config(function (validator) {
                 *    validator.registerDomModifier('customDomModifier', {
                 *      makeValid: function (el) {
                 *          el.removeClass(el, 'invalid');
                 *          el.addClass(el, 'valid');
                 *      },
                 *      makeInvalid: function (el, err, domManipulator) {
                 *          el.removeClass(el, 'valid');
                 *          el.addClass(el, 'invalid');
                 *      }
                 *    });
                 *  });
                         * </pre>
                         *
                         * @param {string} key The key name of the modifier
                         * @param {object} modifier An object which implements the elementModifier interface
                         */
                        this.registerDomModifier = function (key, modifier) {
                            elementStateModifiers[key] = modifier;
                        };

                        /**
                         * @ngdoc function
                         * @name validator#setErrorMessageResolver
                         * @methodOf validator
                         *
                         * @description
                         * Registers an object that adheres to the elementModifier interface and is
                         * able to modifier an elements dom so that appears valid / invalid for a specific
                         * scenario i.e. the Twitter Bootstrap css framework, Foundation CSS framework etc.
                         *
                         * Example:
                         * <pre>
                         *  app.config(function (validator) {
                 *    validator.setErrorMessageResolver(function (errorKey, el) {
                 *      var defer = $q.defer();
                 *      // resolve the correct error from the given key and resolve the returned promise.
                 *      return defer.promise();
                 *    });
                 *  });
                         * </pre>
                         *
                         * @param {function} resolver A method that returns a promise with the resolved error message in.
                         */
                        this.setErrorMessageResolver = function (resolver) {
                            this.errorMessageResolver = resolver;
                        };

                        /**
                         * @ngdoc function
                         * @name validator#getErrorMessage
                         * @methodOf validator
                         *
                         * @description
                         * Resolves the error message for the given error type.
                         *
                         * @param {String} errorKey The error type.
                         * @param {Element} el The UI element that is the focus of the error.
                         * It is provided as the error message may need information from the element i.e. ng-min (the min allowed value).
                         */
                        this.getErrorMessage = function (errorKey, el) {
                            if (this.errorMessageResolver === undefined) {
                                throw new Error('Please set an error message resolver via the setErrorMessageResolver function before attempting to resolve an error message.');
                            }

                            return this.errorMessageResolver(errorKey, el);
                        };

                        this.getDomModifier = function (el) {
                            var modifierKey = (el !== undefined ? el.attr('element-modifier') : this.defaultElementModifier) ||
                                    (el !== undefined ? el.attr('data-element-modifier') : this.defaultElementModifier) ||
                                    this.defaultElementModifier;

                            if (modifierKey === undefined) {
                                throw new Error('Please set a default dom modifier via the setDefaultElementModifier method on the validator class.');
                            }

                            return elementStateModifiers[modifierKey];
                        };

                        this.makeValid = function (el) {
                            this.getDomModifier(el).makeValid(el);
                        };

                        this.makeInvalid = function (el, errorMsg) {
                            this.getDomModifier(el).makeInvalid(el, errorMsg);
                        };

                        this.$get = [

                            function () {
                                return this;
                            }
                        ];
                    }
                ]);
    }(angular));

    (function (angular) {
        'use strict';

        angular.module('jcs-autoValidate')
                .factory('bootstrap3ElementModifier', [

                    function () {
                        var reset = function (el) {
                                    el.find('.help-text').remove();
                                    el.removeClass('has-success has-error has-feedback');

                                    if (addValidationStateIcons) {
                                        el.find('.form-control-feedback').remove();
                                    }
                                },
                                findFormGroupElement = function (el) {
                                    return el.closest('.form-group');
                                },

                                /**
                                 * @ngdoc property
                                 * @name bootstrap3ElementModifier#addValidationStateIcons
                                 * @propertyOf bootstrap3ElementModifier
                                 * @returns {bool} True if an state icon will be added to the element in the valid and invalid control
                                 * states.  The default is false.
                                 */
                                addValidationStateIcons = false,

                                /**
                                 * @ngdoc function
                                 * @name bootstrap3ElementModifier#enableValidationStateIcons
                                 * @methodOf bootstrap3ElementModifier
                                 *
                                 * @description
                                 * Makes an element appear invalid by apply an icon to the input element.
                                 *
                                 * @param {bool} enable - True to enable the icon otherwise false.
                                 */
                                enableValidationStateIcons = function (enable) {
                                    addValidationStateIcons = enable;
                                },

                                /**
                                 * @ngdoc function
                                 * @name bootstrap3ElementModifier#makeValid
                                 * @methodOf bootstrap3ElementModifier
                                 *
                                 * @description
                                 * Makes an element appear valid by apply bootstrap 3 specific styles and child elements. If the service
                                 * property 'addValidationStateIcons' is true it will also append validation glyphicon to the element.
                                 * See: http://getbootstrap.com/css/#forms-control-validation
                                 *
                                 * @param {Element} el - The input control element that is the target of the validation.
                                 */
                                makeValid = function (el) {
                                    var frmGroupEl = findFormGroupElement(el);
                                    reset(frmGroupEl);
                                    frmGroupEl.addClass('has-success has-feedback');
                                    if (addValidationStateIcons) {
                                        frmGroupEl.append(angular.element('<span class="glyphicon glyphicon-ok form-control-feedback"></span>'));
                                    }
                                },

                                /**
                                 * @ngdoc function
                                 * @name bootstrap3ElementModifier#makeInvalid
                                 * @methodOf bootstrap3ElementModifier
                                 *
                                 * @description
                                 * Makes an element appear invalid by apply bootstrap 3 specific styles and child elements. If the service
                                 * property 'addValidationStateIcons' is true it will also append validation glyphicon to the element.
                                 * See: http://getbootstrap.com/css/#forms-control-validation
                                 *
                                 * @param {Element} el - The input control element that is the target of the validation.
                                 */
                                makeInvalid = function (el, errorMsg) {
                                    var frmGroupEl = findFormGroupElement(el),
                                            helpTextEl = angular.element('<span class="help-text has-error">' + errorMsg + '</span>');
                                    reset(frmGroupEl);
                                    frmGroupEl.addClass('has-error has-feedback');
                                    frmGroupEl.append(helpTextEl);
                                    if (addValidationStateIcons) {
                                        frmGroupEl.append(angular.element('<span class="glyphicon glyphicon-remove form-control-feedback"></span>'));
                                    }
                                };

                        return {
                            makeValid: makeValid,
                            makeInvalid: makeInvalid,
                            enableValidationStateIcons: enableValidationStateIcons,
                            key: 'bs3'
                        };
                    }
                ]);
    }(angular));

    (function (angular) {
        'use strict';

        angular.module('jcs-autoValidate').factory('debounce', [

            function () {
                return {
                    debounce: _.debounce
                };
            }
        ]);
    }(angular));

    (function (String, angular) {
        'use strict';

        /**
         * Replaces string placeholders with corresponding template string
         */
        if (!('format' in String.prototype)) {
            String.prototype.format = function () {
                var args = arguments;
                return this.replace(/{(\d+)}/g, function (match, number) {
                    return typeof args[number] !== undefined ? args[number] : match;
                });
            };
        }

        angular.module('jcs-autoValidate')
                .factory('defaultErrorMessageResolver', [
                    '$q',
                    function ($q) {
                        var errorMessages = {
                                    defaultMsg: 'Please add error message for {0}',
                                    email: 'Please enter a valid email address',
                                    minlength: 'Please enter at least {0} characters',
                                    maxlength: 'You have entered more than the maximum {0} characters',
                                    min: 'Please enter the minimum number of {0}',
                                    max: 'Please enter the maximum number of {0}',
                                    required: 'This field is required',
                                    date: 'Please enter a valid date',
                                    pattern: 'Please ensure the entered information adheres to this pattern {0}',
                                    number: 'Please enter a valid number',
                                    url: 'Please enter a valid URL in the format of http(s)://wwww.google.com'
                                },
                                /**
                                 * @ngdoc function
                                 * @name defaultErrorMessageResolver#resolve
                                 * @methodOf defaultErrorMessageResolver
                                 *
                                 * @description
                                 * Resolves a validate error type into a user validation error message
                                 *
                                 * @param {String} errorType - The type of validation error that has occurred.
                                 * @param {Element} el - The input element that is the source of the validation error.
                                 * @returns {Promise} A promise that is resolved when the validation message has been produced.
                                 */
                                resolve = function (errorType, el) {
                                    var defer = $q.defer(),
                                            errMsg = errorMessages[errorType],
                                            parameters = [],
                                            parameter;

                                    if (errMsg === undefined) {
                                        errMsg = errorMessages.defaultMsg.format(errorType);
                                    }

                                    if (el && el.attr) {
                                        try {
                                            parameter = el.attr(errorType);
                                            if (parameter === undefined) {
                                                parameter = el.attr('data-ng-' + errorType) || el.attr('ng-' + errorType);
                                            }

                                            parameters.push(parameter || '');

                                            errMsg = errMsg.format(parameters);
                                        } catch (e) {}
                                    }

                                    defer.resolve(errMsg);
                                    return defer.promise;
                                };

                        return {
                            errorMessages: errorMessages,
                            resolve: resolve
                        };
                    }
                ]);
    }(String, angular));

    (function (angular) {
        'use strict';

        angular.module('jcs-autoValidate')
                .factory('foundation5ElementModifier', [

                    function () {
                        var reset = function (el) {
                                    el.find('small.error').remove();
                                    el.removeClass('error');
                                },
                                findParentColumn = function (el) {
                                    return el.closest('.columns');
                                },

                                /**
                                 * @ngdoc function
                                 * @name foundation5ElementModifier#makeValid
                                 * @methodOf foundation5ElementModifier
                                 *
                                 * @description
                                 * Makes an element appear valid by apply Foundation 5 specific styles and child elements.
                                 * See: http://foundation.zurb.com/docs/components/forms.html
                                 *
                                 * @param {Element} el - The input control element that is the target of the validation.
                                 */
                                makeValid = function (el) {
                                    var parentColumn = findParentColumn(el);
                                    reset(parentColumn && parentColumn.length > 0 ? parentColumn : el);
                                },

                                /**
                                 * @ngdoc function
                                 * @name foundation5ElementModifier#makeInvalid
                                 * @methodOf foundation5ElementModifier
                                 *
                                 * @description
                                 * Makes an element appear invalid by apply Foundation 5 specific styles and child elements.
                                 * See: http://foundation.zurb.com/docs/components/forms.html
                                 *
                                 * @param {Element} el - The input control element that is the target of the validation.
                                 */
                                makeInvalid = function (el, errorMsg) {
                                    var parentColumn = findParentColumn(el),
                                            helpTextEl;
                                    reset(parentColumn || el);
                                    el.addClass('error');
                                    if (parentColumn) {
                                        helpTextEl = angular.element('<small class="error">' + errorMsg + '</small>');
                                        parentColumn.append(helpTextEl);
                                    }
                                };

                        return {
                            makeValid: makeValid,
                            makeInvalid: makeInvalid,
                            key: 'foundation5'
                        };
                    }
                ]);
    }(angular));

    (function (angular) {
        'use strict';

        angular.module('jcs-autoValidate')
                .factory('validationManager', [
                    'validator',
                    function (validator) {
                        var
                                /**
                                 * @ngdoc validateElement
                                 * @name validation#validateElement
                                 * @param {object} modelCtrl holds the information about the element e.g. $invalid, $valid
                                 * @description
                                 * Validate the form element and make invalid/valid element model status.
                                 */
                                validateElement = function (modelCtrl, el) {
                                    var isValid,
                                            errorType,
                                            needsValidation = (modelCtrl.$parsers.length > 0 || modelCtrl.$formatters.length > 0) && modelCtrl.$pristine === false,
                                            findErrorType = function ($errors) {
                                                var keepGoing = true,
                                                        errorTypeToReturn;
                                                angular.forEach($errors, function (status, errortype) {
                                                    if (keepGoing && status) {
                                                        keepGoing = false;
                                                        errorTypeToReturn = errortype;
                                                    }
                                                });

                                                return errorTypeToReturn;
                                            };

                                    if (modelCtrl && needsValidation) {
                                        isValid = !modelCtrl.$invalid;
                                        if (isValid) {
                                            validator.makeValid(el);
                                        } else {
                                            errorType = findErrorType(modelCtrl.$error);

                                            validator.getErrorMessage(errorType, el).then(function (errorMsg) {
                                                validator.makeInvalid(el, errorMsg);
                                            });
                                        }

                                        return isValid;
                                    }
                                };

                        return {
                            validateElement: validateElement
                        };
                    }
                ]);
    }(angular));

    (function (angular) {
        'use strict';

        angular.module('jcs-autoValidate').config(['$provide',
            function ($provide) {
                $provide.decorator('ngModelDirective', [
                    '$delegate',
                    'validationManager',
                    'debounce',
                    function ($delegate, validationManager, debounce) {
                        var directive = $delegate[0],
                                link = directive.link;

                        directive.compile = function () {
                            return function (scope, element, attrs, ctrls) {
                                var ngModelCtrl = ctrls[0],
                                        supportsNgModelOptions = angular.version.major >= 1 && angular.version.minor >= 3,
                                        ngModelOptions = attrs.ngModelOptions === undefined ? undefined : scope.$eval(attrs.ngModelOptions),
                                        setValidity = ngModelCtrl.$setValidity,
                                        setValidationState = debounce.debounce(function () {
                                            validationManager.validateElement(ngModelCtrl, element);
                                        }, 100);

                                if (attrs.formnovalidate === undefined) {
                                    if (supportsNgModelOptions || ngModelOptions === undefined || ngModelOptions.updateOn === undefined || ngModelOptions.updateOn === '') {
                                        ngModelCtrl.$setValidity = function (validationErrorKey, isValid) {
                                            setValidity.call(ngModelCtrl, validationErrorKey, isValid);
                                            setValidationState();
                                        };
                                    } else {
                                        element.on(ngModelOptions.updateOn, function () {
                                            setValidationState();
                                        });

                                        scope.$on('$destroy', function () {
                                            element.off(ngModelOptions.updateOn);
                                        });
                                    }

                                    ngModelCtrl.autoValidated = true;
                                }

                                link.apply(this, arguments);
                            };
                        };

                        return $delegate;
                    }
                ]);
            }
        ]);
    }(angular));

    (function (angular) {
        'use strict';

        angular.module('jcs-autoValidate')
                .run([
                    'validator',
                    'defaultErrorMessageResolver',
                    'bootstrap3ElementModifier',
                    'foundation5ElementModifier',
                    function (validator, defaultErrorMessageResolver, bootstrap3ElementModifier, foundation5ElementModifier) {
                        validator.setErrorMessageResolver(defaultErrorMessageResolver.resolve);
                        validator.registerDomModifier(bootstrap3ElementModifier.key, bootstrap3ElementModifier);
                        validator.registerDomModifier(foundation5ElementModifier.key, foundation5ElementModifier);
                        validator.setDefaultElementModifier(bootstrap3ElementModifier.key);
                    }
                ]);
    }(angular));

    </script>
  <script type="text/javascript">
      (function (angular) {
            var app = angular.module('jcs-demo', ['jcs-autoValidate']);

          app.controller('demoCtrl', [
              '$scope',
              'bootstrap3ElementModifier',
              function ($scope, bootstrap3ElementModifier) {
                $scope.user = {};
                $scope.bs3Icons = false;

                $scope.toggleBS3Icons = function () {
                    $scope.bs3Icons = !$scope.bs3Icons;
                    bootstrap3ElementModifier.enableValidationStateIcons($scope.bs3Icons);
                }
              }
          ]);

          app.factory('myCustomElementModifier', [
                  function () {
                      var /**
                           * @ngdoc function
                           * @name myCustomElementModifier#makeValid
                           * @methodOf myCustomElementModifier
                           *
                           * @description
                           * Makes an element appear valid by apply custom styles and child elements.
                           *
                           * @param {Element} el - The input control element that is the target of the validation.
                           */
                          makeValid = function (el) {
                              el.removeClass('bg-red');
                              el.addClass('bg-green');
                          },

                          /**
                           * @ngdoc function
                           * @name myCustomElementModifier#makeInvalid
                           * @methodOf myCustomElementModifier
                           *
                           * @description
                           * Makes an element appear invalid by apply custom styles and child elements.
                           *
                           * @param {Element} el - The input control element that is the target of the validation.
                           * @param {String} errorMsg - The validation error message to display to the user.
                           */
                          makeInvalid = function (el, errorMsg) {
                              el.removeClass('bg-green');
                              el.addClass('bg-red');
                          };

                      return {
                          makeValid: makeValid,
                          makeInvalid: makeInvalid,
                          key: 'myCustomModifierKey'
                      };
                  }
              ]);

          // now register the custom element modifier with the auto-validate module and set it as the default one for all elements
          app.run([
              'validator',
              'myCustomElementModifier',
              function (validator, myCustomElementModifier) {
                  validator.registerDomModifier(myCustomElementModifier.key, myCustomElementModifier);
              }
          ]);
      }(angular));
  </script>
  </body>
</html>